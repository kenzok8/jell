<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

<style>
:root {
	--bg:#ffffff;
	--card:#f6f8fa;
	--text:#222;
	--border:#ddd;
	--muted:#666;
}
@media (prefers-color-scheme: dark) {
	:root {
		--bg:#0f1115;
		--card:#1b1e24;
		--text:#e5e7eb;
		--border:#333;
		--muted:#9ca3af;
	}
}
body { background:var(--bg); color:var(--text); }

#app {
	all: unset;
	position: relative;
	display: block;
	width: 100%;
	padding: 12px;
	font-family: system-ui,-apple-system;
	text-align: left;
}

.toolbar {
	display:flex;
	justify-content:space-between;
	align-items:center;
	margin-bottom:12px;
}

.toolbar select { margin-left:4px; }

button {
	border-radius:6px;
	padding:6px 10px;
	border:1px solid var(--border);
	background:transparent;
	color:var(--text);
	cursor:pointer;
}

.log-card {
	all: unset;
	display:block;
	position:relative;
	width:100%;
	padding:12px;
	margin-bottom:12px;
	background:var(--card);
	border-left:4px solid #888;
	border-radius:10px;
	text-align: left;
	box-sizing: border-box;
	overflow: hidden;
}

.log-inner {
	all: unset;
	display:block;
	width:100%;
	text-align:left;
	float:none;
	overflow-wrap: break-word;
	word-break: break-word;
}

.log-card.ok { border-color:#2ecc71; }
.log-card.warn { border-color:#f39c12; }
.log-card.err { border-color:#e74c3c; }

#app .log-inner { all: unset; display:block; width:100%; }
#app .log-row {
	all: unset;
	display:flex !important;
	width:100% !important;
	position:relative !important;
	clear:both !important;
	font-size:13px !important;
	line-height:1.8 !important;
	word-break:break-all !important;
	margin-bottom:2px !important;
	text-align:left !important;
	align-items:flex-start !important;
}
#app .log-row .label {
	all: unset;
	flex-shrink: 0 !important;
	text-align:left !important;
	color:var(--muted) !important;
	margin-right:8px !important;
}
#app .log-row .ua { all: unset; font-size:12px !important; color:var(--muted) !important; }

details { margin-top:8px; }
pre {
	margin-top:6px;
	padding:10px;
	border-radius:6px;
	font-size:12px;
	overflow:auto;
	background:rgba(0,0,0,.05);
}
@media (prefers-color-scheme: dark) { pre { background:#0b0d11; } }

.json-key{color:#d97706}
.json-string{color:#16a34a}
.json-number{color:#2563eb}
.json-boolean{color:#dc2626}
.json-null{color:#6b7280}

#toTop {
	position:fixed;
	right:18px;
	bottom:90px;
	padding:8px 14px;
	border-radius:20px;
	background:#273cf3;
	color:#fff;
	display:none;
	z-index:9999;
	cursor:pointer;
}
#toTop.show { display:block; }

@keyframes fadeIn { from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }

@media (max-width:600px){ .log-row{font-size:12px;} }
</style>

<div id="app">
	<div class="toolbar">
		<div>
			<button @click="toggle">{{ paused ? '继续刷新' : '暂停刷新' }}</button>
			<button @click="clear">清空日志</button>
		</div>
		<div style="display:flex;align-items:center;gap:12px;">
			<label>
				<select v-model="filterType">
					<option value="all">全部</option>
					<option value="warn">警告</option>
					<option value="err">错误</option>
				</select>
			</label>
			<span>共 {{ filteredLogs.length }} 条日志</span>
		</div>
	</div>

	<div v-for="(log,i) in filteredLogs" :key="i" class="log-card" :class="statusClass(log.status)">
		<div class="log-inner">
			<div class="log-row"><span class="label">时间：</span>{{ time(log.ts) }}</div>
			<div class="log-row"><span class="label">访问：</span>{{ fullUrl(log) }}</div>
			<div class="log-row"><span class="label">方法：</span>{{ log.request.method }}</div>
			<div class="log-row"><span class="label">状态：</span>{{ log.status }}</div>
			<div class="log-row"><span class="label">IP：</span>{{ realIp(log) }}</div>
			<div class="log-row"><span class="label">标识：</span>{{ userAgent(log) }}</div>
			<div class="log-row"><span class="label">耗时：</span>{{ (log.duration*1000).toFixed(2) }} ms</div>

			<details>
				<summary>原始 JSON 日志</summary>
				<pre v-html="highlight(log)"></pre>
			</details>
		</div>
	</div>
</div>

<div id="toTop">返回顶部</div>

<script>
const { createApp } = Vue;

createApp({
	data() { return { logs: [], paused: false, filterType: 'all' }; },
	computed: {
		filteredLogs() {
			if(this.filterType==='all') return this.logs;
			return this.logs.filter(l=>this.statusClass(l.status)===this.filterType);
		}
	},
	methods: {
		fetch() {
			if(this.paused) return;
			XHR.get('<%=url([[admin]], [[nas]], [[caddy]], [[get_log]])%>', null, x => {
				if(x && x.status===200){
					this.logs = x.responseText.split('\n').filter(Boolean).map(l=>{
						try{ return JSON.parse(l); }catch{return null;}
					}).filter(Boolean).reverse();
				}
			});
		},
		toggle(){ this.paused = !this.paused; },
		clear(){ 
			XHR.get('<%=url([[admin]], [[nas]], [[caddy]], [[clear_log]])%>'); 
			this.logs=[];
		},
		time(ts){ return new Date(ts*1000).toLocaleString(); },
		fullUrl(l){
			const h=l.request.headers||{};
			const p=h['X-Forwarded-Proto']?h['X-Forwarded-Proto'][0]:'http';
			return p+'://'+l.request.host+l.request.uri;
		},
		realIp(l){
			const h=l.request.headers||{};
			return h['Cf-Connecting-Ip']?h['Cf-Connecting-Ip'][0]:l.request.client_ip;
		},
		userAgent(l){
			const h=l.request.headers||{};
			return h['User-Agent']?h['User-Agent'][0]:'未知';
		},
		statusClass(c){
			if(c>=500) return 'err';
			if(c>=400) return 'warn';
			return 'ok';
		},
		highlight(obj){
			let json=JSON.stringify(obj,null,2)
				.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
			json=json.replace(/"([^"]+)"(?=\s*:)/g,'<span class="json-key">"$1"</span>');
			json=json.replace(/"(?:\\.|[^"\\])*"/g, match=>{
				if(match.includes('json-key')) return match;
				return `<span class="json-string">${match}</span>`;
			});
			json=json.replace(/\b\d+(\.\d+)?\b/g,'<span class="json-number">$&</span>')
					 .replace(/\b(true|false)\b/g,'<span class="json-boolean">$1</span>')
					 .replace(/\bnull\b/g,'<span class="json-null">null</span>');
			return json;
		}
	},
	mounted(){
		this.fetch();
		setInterval(this.fetch,2000);

		const btn=document.getElementById('toTop');
		btn.onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
		window.addEventListener('scroll',()=>btn.classList.toggle('show',window.scrollY>400));
	}
}).mount('#app');
</script>
