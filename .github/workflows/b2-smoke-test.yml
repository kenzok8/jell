name: B2 Smoke Test

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  upload-test:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        env:
          B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
          B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
          B2_BUCKET: ${{ secrets.B2_BUCKET }}
        run: |
          set -euo pipefail
          [ -n "$B2_KEY_ID" ] || { echo "Missing B2_KEY_ID"; exit 1; }
          [ -n "$B2_APPLICATION_KEY" ] || { echo "Missing B2_APPLICATION_KEY"; exit 1; }
          [ -n "$B2_BUCKET" ] || { echo "Missing B2_BUCKET"; exit 1; }

      - name: Install rclone
        run: curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone
        env:
          B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
          B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [b2]
          type = b2
          account = ${B2_KEY_ID}
          key = ${B2_APPLICATION_KEY}
          hard_delete = true
          EOF

      - name: Upload smoke file to B2
        env:
          B2_BUCKET: ${{ secrets.B2_BUCKET }}
          B2_PUBLIC_BASE_URL: ${{ secrets.B2_PUBLIC_BASE_URL }}
        run: |
          set -euo pipefail
          TS=$(date +%Y%m%d-%H%M%S)
          PREFIX="op/smoke-test/jell/${TS}"
          echo "b2 upload test ${TS}" > smoke-test.txt
          rclone copy smoke-test.txt "b2:${B2_BUCKET}/${PREFIX}/" --checksum --fast-list
          rclone lsf "b2:${B2_BUCKET}/${PREFIX}/"
          BASE_URL="${B2_PUBLIC_BASE_URL:-https://f000.backblazeb2.com/file/${B2_BUCKET}}"
          echo "Uploaded: ${BASE_URL%/}/${PREFIX}/smoke-test.txt"
